<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬°Tu Compra Ya! v2.0 - Cotizador PRO</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter & Oswald for Logo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Oswald:wght@600&display=swap" rel="stylesheet">
    <!-- Iconos de Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Variables CSS para colores de tema din√°micos */
        :root {
            --current-primary: #0284c7; /* Por defecto a Food Market Sky-600 */
            --current-primary-light: #38bdf8; /* Por defecto a Food Market Sky-400 para el icono de luna del modo oscuro */
        }

        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 90px;
        }
        @media (min-width: 1024px) { body { padding-bottom: 0; } }
        
        /* Estilos de barra de desplazamiento personalizados */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        html.dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }

        #category-filters::-webkit-scrollbar { display: none; }
        #category-filters {
            -ms-overflow-style: none;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }

        .banner {
            height: 200px;
            background-size: cover;
            background-position: center;
        }
        .logo-font {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
        }

        /* Animaciones modales */
        .modal-enter { transform: translateY(100%); opacity: 0; }
        .modal-enter-active { transform: translateY(0); opacity: 1; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        .modal-leave-active { transform: translateY(100%); opacity: 0; transition: transform 0.3s ease-in, opacity 0.3s ease-in; }
        
        .fly-to-cart {
            position: absolute;
            font-size: 2rem;
            z-index: 100;
            transition: all 0.6s ease-in-out;
        }
        .cart-pulse { animation: pulse 0.5s; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .btn-base {
            @apply text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all duration-300;
        }
        .btn-base:hover { @apply shadow-lg transform scale-105; }
        .btn-base:disabled { @apply cursor-not-allowed scale-100 shadow-none; }

        .product-card-base {
            @apply bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-3 flex flex-col justify-between transition-all duration-300;
        }
        .product-card-base:hover { @apply shadow-xl transform -translate-y-1; }

        .focus\:ring-current-primary:focus { --tw-ring-color: var(--current-primary); }

        .category-card-base {
            @apply flex flex-col items-center justify-center p-4 rounded-xl transition-colors bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 shadow-md;
            min-width: 140px;
            height: 160px;
            flex-shrink: 0;
            text-align: center;
            gap: 8px;
        }
        .category-card-base:hover { @apply shadow-lg transform -translate-y-1; }
        .category-card-base img { @apply w-28 h-28 rounded-full object-cover; }
        .category-card-base span {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.2;
        }
        .category-card-base.premium-highlight {
            border: 2px solid gold;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--current-primary);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">
    
    <div id="main-banner" class="banner rounded-b-3xl shadow-lg flex items-center justify-center relative">
        <div id="banner-fade-overlay" class="absolute inset-0 bg-black opacity-0 rounded-b-3xl transition-opacity duration-1000 ease-in-out"></div>
        <div class="absolute inset-0 bg-black opacity-40 rounded-b-3xl"></div>
        <h1 id="banner-title" class="text-5xl md:text-6xl font-extrabold text-white z-10" style="text-shadow: 3px 3px 8px rgba(0,0,0,0.6);">Mercado F√°cil</h1>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-4 text-center">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white"></h1>
            <p id="main-subtitle" class="text-slate-600 dark:text-slate-400 mt-2"></p>
        </header>

        <!-- Controles Globales -->
        <div class="z-30 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm py-4 mb-4">
            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                <div id="shop-switcher" class="flex gap-2 bg-white dark:bg-slate-800 p-2 rounded-xl shadow-md"></div>
                <div class="relative w-full md:max-w-xs">
                    <input type="search" id="search-input" class="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-xl p-2 pl-10 focus:ring-2 focus:ring-current-primary">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
                <div class="flex items-center gap-4 bg-white dark:bg-slate-800 p-2 rounded-xl shadow-md">
                    <select id="language-switcher" class="bg-slate-100 dark:bg-slate-700 border-none rounded-md p-1 font-semibold text-sm focus:ring-2 focus:ring-current-primary"></select>
                    <select id="currency-switcher" class="bg-slate-100 dark:bg-slate-700 border-none rounded-md p-1 font-semibold text-sm focus:ring-2 focus:ring-current-primary"></select>
                    <button id="dark-mode-toggle" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i class="ph ph-sun text-xl text-yellow-500"></i>
                        <i class="ph ph-moon hidden text-xl" style="color: var(--current-primary-light);"></i>
                    </button>
                </div>
            </div>
            <div class="relative flex items-center justify-center w-full mt-4">
                <button id="scroll-left-btn" class="hidden md:flex absolute left-0 z-10 p-2 rounded-full bg-white/80 dark:bg-slate-800/80 shadow-md hover:bg-white dark:hover:bg-slate-700 transition-colors"><i class="ph ph-caret-left text-xl text-slate-600 dark:text-slate-300"></i></button>
                <div id="category-filters" class="flex gap-3 overflow-x-auto pb-2 px-4 w-full justify-start"></div>
                <button id="scroll-right-btn" class="hidden md:flex absolute right-0 z-10 p-2 rounded-full bg-white/80 dark:bg-slate-800/80 shadow-md hover:bg-white dark:hover:bg-slate-700 transition-colors"><i class="ph ph-caret-right text-xl text-slate-600 dark:text-slate-300"></i></button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-lg">
                    <h2 id="products-title" class="text-xl md:text-2xl font-semibold mb-6 flex items-center"></h2>
                    <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 gap-4 custom-scrollbar min-h-[50vh]"></div>
                </div>
            </div>
            <div class="hidden lg:block lg:col-span-1">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg sticky top-28">
                    <h2 id="quote-title-desktop" class="text-2xl font-semibold mb-6 flex items-center"></h2>
                    <div id="cart-items-desktop" class="space-y-4 mb-6 min-h-[150px] max-h-[40vh] overflow-y-auto custom-scrollbar"></div>
                    <div id="cart-totals-desktop"></div>
                    <div id="cart-buttons-desktop" class="mt-6 space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Carrito Fija para M√≥viles -->
    <div id="mobile-cart-bar" class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 p-3 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] flex items-center justify-between">
        <div>
            <p id="mobile-total-label" class="text-sm text-slate-500 dark:text-slate-400">Total</p>
            <p id="mobile-total-amount" class="font-bold text-xl text-slate-800 dark:text-slate-200">$0</p>
        </div>
        <button id="view-cart-btn" class="flex items-center gap-2 disabled:cursor-not-allowed">
            <i id="mobile-cart-icon" class="ph ph-shopping-cart-simple text-xl"></i>
            <span id="view-cart-label">Ver Carrito</span>
        </button>
    </div>

    <!-- Modal de Carrito para M√≥viles -->
    <div id="mobile-cart-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40">
        <div id="modal-content" class="absolute bottom-0 left-0 right-0 bg-slate-100 dark:bg-slate-900 rounded-t-2xl p-4 max-h-[85vh] overflow-y-auto transition-transform duration-300 ease-in-out modal-enter custom-scrollbar">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                <h2 id="quote-title-mobile" class="text-2xl font-semibold flex items-center"></h2>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 dark:hover:text-white"><i class="ph ph-x text-3xl"></i></button>
            </div>
            <div id="cart-items-mobile" class="space-y-4 mb-6"></div>
            <div id="cart-totals-mobile" class="bg-white dark:bg-slate-800 p-4 rounded-xl"></div>
            <div id="cart-buttons-mobile" class="mt-6 space-y-3"></div>
        </div>
    </div>

    <!-- Modal de Receta con IA -->
    <div id="recipe-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div id="recipe-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] flex flex-col transition-transform duration-300 ease-in-out scale-95 opacity-0">
             <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                <h2 id="recipe-modal-title" class="text-2xl font-semibold flex items-center text-slate-800 dark:text-white"></h2>
                <button id="close-recipe-modal-btn" class="text-slate-500 hover:text-slate-800 dark:hover:text-white"><i class="ph ph-x text-3xl"></i></button>
            </div>
            <div id="recipe-modal-body" class="overflow-y-auto custom-scrollbar">
                <!-- El contenido de la receta (o el spinner) se insertar√° aqu√≠ -->
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- 1. DATA AND CONFIGURATION ---
            const SHOPS_CONFIG = {
                'foodMarket': {
                    id: 'foodMarket',
                    name: 'Food Market',
                    banner: 'https://images.unsplash.com/photo-1583258292688-d0213dc5a3a8?q=80&w=2574&auto=format&fit=crop',
                    bannerTitle: 'Mercado F√°cil',
                    logoFontClass: '',
                    bannerImages: [
                        'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/01%20verduras.png',
                        'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/02%20lacteos.png',
                        'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/09%20despensa.png',
                        'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/11%20bebidas.png',
                        'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/18%20congelados.png'
                    ],
                    products: [
                        { id: 1, name: "Arroz Blanco (1kg)", price: 5500, icon: "üçö", category: "pantry" },
                        { id: 2, name: "Leche Entera (1L)", price: 4200, icon: "ü•õ", category: "dairy" },
                        { id: 3, name: "Huevos (x30)", price: 18000, icon: "ü•ö", category: "dairy" },
                        { id: 4, name: "Caf√© Colombiano (500g)", price: 22000, icon: "‚òï", category: "pantry" },
                        { id: 5, name: "Aceite Vegetal (1L)", price: 15500, icon: "üçæ", category: "pantry" },
                        { id: 6, name: "Pan Tajado (550g)", price: 6000, icon: "üçû", category: "bakery" },
                        { id: 7, name: "Queso Campesino (400g)", price: 11000, icon: "üßÄ", category: "dairy" },
                        { id: 8, name: "Manzanas (1kg)", price: 7500, icon: "üçé", category: "fruits_veg" },
                        { id: 9, name: "Pollo Entero (1kg)", price: 14000, icon: "üçó", category: "meats" },
                        { id: 10, name: "Papas (1kg)", price: 3500, icon: "ü•î", category: "fruits_veg" },
                        { id: 11, name: "Tomates (1kg)", price: 4000, icon: "üçÖ", category: "fruits_veg" },
                        { id: 12, name: "Cebolla (1kg)", price: 3800, icon: "üßÖ", category: "fruits_veg" },
                        { id: 13, name: "Salm√≥n (200g)", price: 25000, icon: "üêü", category: "meats" },
                        { id: 14, name: "Yogur Griego", price: 8000, icon: "üç¶", category: "dairy" },
                        { id: 15, name: "Baguette", price: 4500, icon: "ü•ñ", category: "bakery" },
                        { id: 16, name: "Banano (1kg)", price: 3200, icon: "üçå", category: "fruits_veg" },
                        { id: 17, name: "Aguacate Hass", price: 4500, icon: "ü•ë", category: "fruits_veg" },
                        { id: 18, name: "Lechuga Crespa", price: 2500, icon: "ü•¨", category: "fruits_veg" },
                        { id: 19, name: "Zanahoria (500g)", price: 1800, icon: "ü•ï", category: "fruits_veg" },
                        { id: 20, name: "Lim√≥n (1kg)", price: 4000, icon: "üçã", category: "fruits_veg" },
                        { id: 21, name: "Br√≥coli", price: 3500, icon: "ü•¶", category: "fruits_veg" },
                        { id: 22, name: "Carne Molida (500g)", price: 15000, icon: "ü•©", category: "meats" },
                        { id: 23, name: "Chuleta de Cerdo (500g)", price: 12000, icon: "ü•ì", category: "meats" },
                        { id: 24, name: "Salchichas (x8)", price: 9000, icon: "üå≠", category: "meats" },
                        { id: 60, name: "Costilla de Res (1kg)", price: 28000, icon: "üçñ", category: "meats" },
                        { id: 61, name: "Pechuga de Pollo sin Hueso (500g)", price: 12000, icon: "üçó", category: "meats" },
                        { id: 62, name: "Carne para Asar (500g)", price: 20000, icon: "ü•©", category: "meats" },
                        { id: 25, name: "Mantequilla (250g)", price: 7500, icon: "üßà", category: "dairy" },
                        { id: 26, name: "Queso Mozzarella (250g)", price: 9500, icon: "üßÄ", category: "dairy" },
                        { id: 27, name: "Leche Deslactosada (1L)", price: 4800, icon: "ü•õ", category: "dairy" },
                        { id: 28, name: "Pasta Spaghetti (500g)", price: 4500, icon: "üçù", category: "pantry" },
                        { id: 29, name: "Lentejas (500g)", price: 4000, icon: "ü´ò", category: "pantry" },
                        { id: 30, name: "Frijol Cargamanto (500g)", price: 6500, icon: "ü´ò", category: "pantry" },
                        { id: 31, name: "At√∫n en Aceite", price: 5500, icon: "ü•´", category: "pantry" },
                        { id: 32, name: "Mayonesa (200g)", price: 6000, icon: "üß¥", category: "pantry" },
                        { id: 33, name: "Salsa de Tomate (200g)", price: 4500, icon: "üçÖ", category: "pantry" },
                        { id: 34, name: "Az√∫car (1kg)", price: 5000, icon: "üç¨", category: "pantry" },
                        { id: 35, name: "Sal (1kg)", price: 2000, icon: "üßÇ", category: "pantry" },
                        { id: 36, name: "Harina de Trigo (500g)", price: 3000, icon: "üåæ", category: "pantry" },
                        { id: 37, name: "Croissant", price: 3500, icon: "ü•ê", category: "bakery" },
                        { id: 38, name: "Torta de Chocolate (Porci√≥n)", price: 8000, icon: "üç∞", category: "bakery" },
                        { id: 39, name: "Arepas de Ma√≠z (x5)", price: 4000, icon: "ü´ì", category: "bakery" },
                        { id: 40, name: "Agua Botella (600ml)", price: 2000, icon: "üíß", category: "drinks" },
                        { id: 41, name: "Coca-Cola (1.5L)", price: 4500, icon: "ü•§", category: "drinks" },
                        { id: 42, name: "Jugo de Naranja (1L)", price: 6000, icon: "üßÉ", category: "drinks" },
                        { id: 43, name: "Cerveza Nacional (x6)", price: 15000, icon: "üç∫", category: "drinks" },
                        { id: 44, name: "Vino Tinto (750ml)", price: 35000, icon: "üç∑", category: "drinks" },
                        { id: 45, name: "Papas Fritas (Paquete)", price: 3000, icon: "üçü", category: "snacks" },
                        { id: 46, name: "Galletas de Chocolate", price: 2500, icon: "üç™", category: "snacks" },
                        { id: 47, name: "Man√≠ Salado (150g)", price: 4000, icon: "ü•ú", category: "snacks" },
                        { id: 48, name: "Barra de Chocolate", price: 3500, icon: "üç´", category: "snacks" },
                        { id: 49, name: "Detergente L√≠quido (1L)", price: 18000, icon: "üßº", category: "cleaning" },
                        { id: 50, name: "Limpiador Multiusos", price: 9000, icon: "‚ú®", category: "cleaning" },
                        { id: 51, name: "Lavaloza L√≠quido (500ml)", price: 7000, icon: "üçΩÔ∏è", category: "cleaning" },
                        { id: 52, name: "Papel Higi√©nico (x4)", price: 6000, icon: "üßª", category: "cleaning" },
                        { id: 53, name: "Jab√≥n de Ba√±o", price: 3000, icon: "üöø", category: "personal_care" },
                        { id: 54, name: "Shampoo (400ml)", price: 15000, icon: "üß¥", category: "personal_care" },
                        { id: 55, name: "Crema Dental", price: 8000, icon: "ü¶∑", category: "personal_care" },
                        { id: 56, name: "Desodorante", price: 12000, icon: "üå¨Ô∏è", category: "personal_care" },
                        { id: 57, name: "Papas a la Francesa (Cong.)", price: 9000, icon: "üçü", category: "frozen" },
                        { id: 58, name: "Helado de Vainilla (1L)", price: 15000, icon: "üç®", category: "frozen" },
                        { id: 59, name: "Pizza Congelada", price: 20000, icon: "üçï", category: "frozen" },
                    ],
                    categories: {
                        es: { all: "Todos", fruits_veg: "Frutas y Verduras", dairy: "L√°cteos y Huevos", meats: "Carnes", pantry: "Despensa", bakery: "Panader√≠a", drinks: "Bebidas", snacks: "Snacks", cleaning: "Limpieza", personal_care: "Cuidado Personal", frozen: "Congelados" },
                        en: { all: "All", fruits_veg: "Fruits & Veg", dairy: "Dairy & Eggs", meats: "Meats", pantry: "Pantry", bakery: "Bakery", drinks: "Beverages", snacks: "Snacks", cleaning: "Cleaning", personal_care: "Personal Care", frozen: "Frozen" }
                    },
                    translations: {
                        es: {
                            pageTitle: "¬°Tu Compra Ya! - Cotizador PRO",
                            mainTitle: "¬°Tu Compa Ya!",
                            mainSubtitle: "Selecciona productos para agregarlos a tu canasta de compra",
                            productsTitle: '<i class="ph ph-basket text-current-primary mr-2"></i> Productos Disponibles',
                            quoteTitleDesktop: '<i class="ph ph-shopping-cart-simple text-current-primary mr-2"></i> Tu Canasta',
                            quoteTitleMobile: '<i class="ph ph-shopping-cart-simple text-current-primary mr-2"></i> Tu Canasta',
                            addToCart: "Agregar",
                            addedToCart: "Agregado",
                            subtotal: "Subtotal:",
                            iva: "IVA (19%):",
                            total: "Total:",
                            sendWhatsApp: "Enviar por WhatsApp",
                            clearQuote: "Limpiar Canasta",
                            mobileTotalLabel: "Total",
                            viewCart: "Ver Carrito",
                            cartEmpty: "Tu canasta est√° vac√≠a. ¬°Agrega algunos productos!",
                            noProductsFound: "No se encontraron productos para tu b√∫squeda.",
                            searchPlaceholder: "Buscar productos...",
                            language: "Idioma",
                            currency: "Moneda",
                            shopName: "Food Market",
                            generateRecipe: "‚ú® Generar Receta",
                            generatingRecipe: "Generando receta...",
                            recipeModalTitle: "Receta Sugerida por IA",
                            recipeError: "Hubo un error al generar la receta. Por favor, intenta de nuevo."
                        },
                        en: {
                            pageTitle: "Your Buddy Now! - Quote PRO",
                            mainTitle: "Your Buddy Now!",
                            mainSubtitle: "Select products to add to your shopping basket",
                            productsTitle: '<i class="ph ph-basket text-current-primary mr-2"></i> Available Products',
                            quoteTitleDesktop: '<i class="ph ph-shopping-cart-simple text-current-primary mr-2"></i> Your Basket',
                            quoteTitleMobile: '<i class="ph ph-shopping-cart-simple text-current-primary mr-2"></i> Your Basket',
                            addToCart: "Add",
                            addedToCart: "Added",
                            subtotal: "Subtotal:",
                            iva: "VAT (19%):",
                            total: "Total:",
                            sendWhatsApp: "Send via WhatsApp",
                            clearQuote: "Clear Basket",
                            mobileTotalLabel: "Total",
                            viewCart: "View Cart",
                            cartEmpty: "Your basket is empty. Add some products!",
                            noProductsFound: "No products found for your search.",
                            searchPlaceholder: "Search products...",
                            language: "Language",
                            currency: "Currency",
                            shopName: "Food Market",
                            generateRecipe: "‚ú® Generate Recipe",
                            generatingRecipe: "Generating recipe...",
                            recipeModalTitle: "AI Suggested Recipe",
                            recipeError: "There was an error generating the recipe. Please try again."
                        }
                    },
                    theme: {
                        primaryColor: 'sky',
                        primaryColorHex: '#0284c7',
                        primaryColorLightHex: '#38bdf8',
                        buttonClass: 'btn-primary-sky',
                        productPriceColor: 'slate-600',
                        categoryColors: { fruits_veg: 'green', dairy: 'blue', meats: 'red', pantry: 'orange', bakery: 'yellow', drinks: 'indigo', snacks: 'purple', cleaning: 'teal', personal_care: 'pink', frozen: 'cyan' },
                        categoryImageUrls: { 
                            fruits_veg: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/01%20verduras.png',
                            dairy: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/02%20lacteos2.png', 
                            meats: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/03%20carnes.png', 
                            pantry: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/05%20despensa.png',
                            bakery: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/06%20panaderi%CC%81a.png', 
                            drinks: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/07%20bebidas.png', 
                            snacks: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/08%20snacks.png', 
                            cleaning: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/09%20limpieza.png', 
                            personal_care: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/12%20cuidado%20personal.png', 
                            frozen: 'https://raw.githubusercontent.com/NucleoColectivo/compra/main/IMG/ICONOS/11%20congeladosl.png' 
                        }
                    }
                },
                'butcherShop': {
                    id: 'butcherShop',
                    name: 'The Premium Cut',
                    banner: 'https://images.unsplash.com/photo-1607623814075-e51df1bdc82f?q=80&w=2670&auto=format&fit=crop',
                    bannerTitle: 'The Premium Cut',
                    logoFontClass: 'logo-font',
                    products: [
                        { id: 101, name: "Lomo de Res (500g)", price: 35000, icon: "ü•©", category: "res" },
                        { id: 102, name: "Punta de Anca (1kg)", price: 60000, icon: "ü•©", category: "res" },
                        { id: 103, name: "Chuletas de Cerdo (500g)", price: 18000, icon: "ü•ì", category: "cerdo" },
                        { id: 104, name: "Pechuga de Pollo (1kg)", price: 22000, icon: "üçó", category: "pollo" },
                        { id: 105, name: "Chorizo Santarrosano (x5)", price: 15000, icon: "üå≠", category: "embutidos" },
                        { id: 106, name: "Morcilla (500g)", price: 12000, icon: "‚ö´", category: "embutidos" },
                        { id: 107, name: "Salami Genoa (100g)", price: 18000, icon: "üßÄ", category: "charcuteria" },
                        { id: 108, name: "Queso Manchego (150g)", price: 25000, icon: "üßÄ", category: "charcuteria" },
                        { id: 109, name: "Costillas de Cerdo BBQ (1kg)", price: 45000, icon: "üçñ", category: "cerdo" },
                        { id: 110, name: "Carne para Hamburguesa (x4)", price: 20000, icon: "üçî", category: "res" },
                        { id: 111, name: "Alitas de Pollo (1kg)", price: 19000, icon: "üçó", category: "pollo" },
                        { id: 112, name: "Jam√≥n Serrano (100g)", price: 28000, icon: "ü•ì", category: "charcuteria" },
                    ],
                    categories: {
                        es: { all: "Todo üî™", res: "Res ü•©", cerdo: "Cerdo ü•ì", pollo: "Pollo üçó", embutidos: "Embutidos üå≠", charcuteria: "Charcuter√≠a üßÄ" },
                        en: { all: "All üî™", res: "Beef ü•©", cerdo: "Pork ü•ì", pollo: "Chicken üçó", embutidos: "Sausages üå≠", charcuteria: "Deli üßÄ" }
                    },
                    translations: {
                        es: {
                            pageTitle: "The Premium Cut - Carnicer√≠a & Charcuter√≠a",
                            mainTitle: "Cortes de Calidad para su Mesa ü•©",
                            mainSubtitle: "Seleccione los mejores cortes de carne, embutidos y productos deli.",
                            productsTitle: '<i class="ph ph-knife text-current-primary mr-3"></i> Nuestros Productos',
                            quoteTitleDesktop: '<i class="ph ph-shopping-cart text-current-primary mr-3"></i> Su Pedido',
                            quoteTitleMobile: '<i class="ph ph-shopping-cart text-current-primary mr-3"></i> Su Pedido',
                            addToCart: "Agregar",
                            addedToCart: "Agregado",
                            subtotal: "Subtotal:",
                            iva: "IVA (19%):",
                            total: "Total:",
                            sendWhatsApp: "Hacer Pedido por WhatsApp",
                            clearQuote: "Vaciar Carrito",
                            mobileTotalLabel: "Total",
                            viewCart: "Ver Pedido",
                            cartEmpty: "Su carrito est√° vac√≠o. ¬°Elija sus cortes!",
                            noProductsFound: "No se encontraron esos cortes.",
                            searchPlaceholder: "Buscar carnes, quesos...",
                            language: "Idioma",
                            currency: "Moneda",
                            shopName: "The Premium Cut",
                            generateRecipe: "‚ú® Sugerir Preparaci√≥n",
                            generatingRecipe: "Buscando sugerencias...",
                            recipeModalTitle: "Sugerencia del Chef IA",
                            recipeError: "Hubo un error al generar la sugerencia. Por favor, intenta de nuevo."
                        },
                        en: {
                            pageTitle: "The Premium Cut - Butcher & Deli",
                            mainTitle: "Quality Cuts for Your Table ü•©",
                            mainSubtitle: "Select the best meat cuts, sausages, and deli products.",
                            productsTitle: '<i class="ph ph-knife text-current-primary mr-3"></i> Our Products',
                            quoteTitleDesktop: '<i class="ph ph-shopping-cart text-current-primary mr-3"></i> Your Order',
                            quoteTitleMobile: '<i class="ph ph-shopping-cart text-current-primary mr-3"></i> Your Order',
                            addToCart: "Add",
                            addedToCart: "Added",
                            subtotal: "Subtotal:",
                            iva: "VAT (19%):",
                            total: "Total:",
                            sendWhatsApp: "Order on WhatsApp",
                            clearQuote: "Empty Cart",
                            mobileTotalLabel: "Total",
                            viewCart: "View Order",
                            cartEmpty: "Your cart is empty. Choose your cuts!",
                            noProductsFound: "Those cuts were not found.",
                            searchPlaceholder: "Search for meats, cheeses...",
                            language: "Language",
                            currency: "Currency",
                            shopName: "The Premium Cut",
                            generateRecipe: "‚ú® Suggest Preparation",
                            generatingRecipe: "Getting suggestions...",
                            recipeModalTitle: "AI Chef's Suggestion",
                            recipeError: "There was an error generating the suggestion. Please try again."
                        }
                    },
                    theme: {
                        primaryColor: 'red',
                        primaryColorHex: '#ef4444',
                        primaryColorLightHex: '#f87171',
                        buttonClass: 'btn-primary-red',
                        productPriceColor: 'red-600',
                        categoryColors: { all: 'red', res: 'red', cerdo: 'red', pollo: 'red', embutidos: 'red', charcuteria: 'red' }
                    }
                }
            };

            let exchangeRates = { COP: 1, USD: 0.00025, EUR: 0.00023 };

            // --- APPLICATION STATE ---
            let state = {
                cart: [],
                lang: 'es',
                currency: 'COP',
                darkMode: false,
                searchQuery: '',
                activeCategory: 'all',
                activeShop: 'foodMarket',
                currentBannerIndex: 0
            };

            // --- DOM REFERENCES ---
            const dom = {}; 

            // --- API SIMULATION & HELPERS ---
            const fetchExchangeRates = async () => {
                await new Promise(resolve => setTimeout(resolve, 500));
                return { COP: 1, USD: 0.00025 + Math.random() * 0.00001, EUR: 0.00023 + Math.random() * 0.00001 };
            };
            
            let bannerInterval;

            // --- INITIALIZATION LOGIC ---
            const init = async () => {
                defineDomElements();
                loadState();
                try {
                    exchangeRates = await fetchExchangeRates();
                } catch (error) {
                    console.error("Failed to fetch exchange rates, using default.", error);
                }
                setupEventListeners();
                updateUI();
            };

            // --- STATE LOGIC (localStorage) ---
            const saveState = () => {
                const stateToSave = {
                    cart: state.cart,
                    lang: state.lang,
                    currency: state.currency,
                    darkMode: state.darkMode,
                    activeShop: state.activeShop,
                    currentBannerIndex: state.currentBannerIndex
                };
                localStorage.setItem('foodMarketAppState', JSON.stringify(stateToSave));
            };
            
            const loadState = () => {
                const savedState = JSON.parse(localStorage.getItem('foodMarketAppState'));
                if (savedState) {
                    state = { ...state, ...savedState };
                }
                if (state.darkMode) {
                    document.documentElement.classList.add('dark');
                }
                populateLanguageSwitcher();
                populateCurrencySwitcher();
                dom.languageSwitcher.value = state.lang;
                dom.currencySwitcher.value = state.currency;
            };

            // --- RENDERING LOGIC ---
            const updateUI = () => {
                const currentShop = SHOPS_CONFIG[state.activeShop];
                
                dom.bannerTitle.textContent = currentShop.bannerTitle;
                dom.bannerTitle.className = `text-5xl md:text-6xl font-extrabold text-white z-10 ${currentShop.logoFontClass || ''}`;
                
                document.documentElement.style.setProperty('--current-primary', currentShop.theme.primaryColorHex);
                document.documentElement.style.setProperty('--current-primary-light', currentShop.theme.primaryColorLightHex);

                updateTexts();
                renderShopSwitcher();
                renderCategoryFilters();
                renderProducts();
                renderCart();
                updateDarkModeToggle();
                startBannerRotation();
            };

            const updateTexts = () => {
                const t = SHOPS_CONFIG[state.activeShop].translations[state.lang];
                document.title = t.pageTitle;
                dom.mainTitle.textContent = t.mainTitle;
                dom.mainSubtitle.textContent = t.mainSubtitle;
                dom.searchInput.placeholder = t.searchPlaceholder;
                dom.viewCartLabel.textContent = t.viewCart;
                dom.productsTitle.innerHTML = t.productsTitle;
                dom.quoteTitleDesktop.innerHTML = t.quoteTitleDesktop;
                dom.quoteTitleMobile.innerHTML = t.quoteTitleMobile;
                dom.mobileTotalLabel.textContent = t.mobileTotalLabel;
            };

            const renderShopSwitcher = () => {
                dom.shopSwitcher.innerHTML = Object.values(SHOPS_CONFIG).map(shop => {
                    const isActive = state.activeShop === shop.id;
                    const activeClasses = `bg-${shop.theme.primaryColor}-600 text-white shadow-lg`;
                    const inactiveClasses = `bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600`;
                    return `<button data-shop="${shop.id}" class="shop-btn px-4 py-2 rounded-xl font-semibold text-sm transition-colors ${isActive ? activeClasses : inactiveClasses}">${shop.translations[state.lang].shopName}</button>`;
                }).join('');
            };
            
            const renderCategoryFilters = () => {
                const currentShop = SHOPS_CONFIG[state.activeShop];
                const t = currentShop.categories[state.lang];
                const theme = currentShop.theme;

                dom.categoryFilters.innerHTML = Object.entries(t).map(([key, value]) => {
                    const isActive = state.activeCategory === key;
                    const categoryColor = theme.categoryColors[key] || theme.primaryColor;
                    const activeClasses = `bg-${categoryColor}-600 text-white shadow-lg`;
                    const inactiveClasses = `bg-white dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600`;
                    const imageUrl = theme.categoryImageUrls ? theme.categoryImageUrls[key] : null;
                    const content = imageUrl 
                        ? `<img src="${imageUrl}" alt="${value}" onerror="this.onerror=null;this.src='https://placehold.co/112x112/cccccc/000000?text=IMG';" class="w-28 h-28 rounded-full object-cover"><span>${value}</span>`
                        : `<span>${value}</span>`;
                    const premiumClass = state.activeShop === 'butcherShop' && key !== 'all' ? 'premium-highlight' : '';
                    return `<button data-category="${key}" class="category-card-base ${isActive ? activeClasses : inactiveClasses} ${premiumClass}">${content}</button>`;
                }).join('');
            };

            const renderProducts = () => {
                const currentShop = SHOPS_CONFIG[state.activeShop];
                const t = currentShop.translations[state.lang];
                const filteredProducts = currentShop.products.filter(p => 
                    (state.activeCategory === 'all' || p.category === state.activeCategory) &&
                    p.name.toLowerCase().includes(state.searchQuery.toLowerCase())
                );

                if (filteredProducts.length === 0) {
                    dom.productList.innerHTML = `<p class="col-span-full text-center text-slate-500 py-10">${t.noProductsFound}</p>`;
                    return;
                }

                dom.productList.innerHTML = filteredProducts.map(product => {
                    const displayPrice = product.price * exchangeRates[state.currency];
                    const isInCart = state.cart.some(item => item.id === product.id);
                    const categoryButtonColor = currentShop.theme.categoryColors[product.category] || currentShop.theme.primaryColor;
                    const buttonClasses = isInCart ? 'bg-green-500 text-white' : `bg-${categoryButtonColor}-600 text-white hover:bg-${categoryButtonColor}-700`;
                    const productPriceColorClass = `text-${categoryButtonColor}-600`;

                    return `
                        <div class="product-card-base">
                            <div>
                                <div class="text-3xl mb-2">${product.icon}</div>
                                <h3 class="font-semibold text-slate-800 dark:text-slate-200 text-sm">${product.name}</h3>
                                <p class="font-bold text-base mt-1 ${productPriceColorClass}">${formatCurrency(displayPrice)}</p>
                            </div>
                            <button data-id="${product.id}" class="add-to-cart-btn mt-3 w-full py-2 px-1 rounded-lg font-semibold text-sm transition-colors flex items-center justify-center gap-1 ${buttonClasses}">
                                <i class="ph ${isInCart ? 'ph-check-circle' : 'ph-plus-circle'}"></i>
                                <span data-id="${product.id}">${isInCart ? t.addedToCart : t.addToCart}</span>
                            </button>
                        </div>`;
                }).join('');
            };

            const renderCart = () => {
                const currentShop = SHOPS_CONFIG[state.activeShop];
                const t = currentShop.translations[state.lang];
                let subtotal = 0;
                
                const activeShopProducts = currentShop.products;
                const cartItemsForActiveShop = state.cart.filter(cartItem => activeShopProducts.some(p => p.id === cartItem.id));

                const cartItemsHTML = cartItemsForActiveShop.length === 0 
                    ? `<div class="text-center text-slate-500 dark:text-slate-400 py-10"><i class="ph ph-shopping-cart text-5xl"></i><p class="mt-2 font-medium">${t.cartEmpty}</p></div>`
                    : cartItemsForActiveShop.map(item => {
                        const product = activeShopProducts.find(p => p.id === item.id);
                        const itemPrice = product.price * exchangeRates[state.currency];
                        subtotal += itemPrice * item.quantity;
                        return `
                            <div class="flex items-center justify-between gap-2">
                                <div class="flex-grow"><p class="font-semibold text-sm">${product.name}</p><p class="text-xs text-slate-500 dark:text-slate-400">${formatCurrency(itemPrice)}</p></div>
                                <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 rounded-full p-1">
                                    <button data-id="${item.id}" class="decrease-quantity-btn w-6 h-6 rounded-full bg-white dark:bg-slate-600 shadow-sm hover:bg-slate-200 dark:hover:bg-slate-500 transition">-</button>
                                    <span class="font-bold w-5 text-center text-sm">${item.quantity}</span>
                                    <button data-id="${item.id}" class="increase-quantity-btn w-6 h-6 rounded-full bg-white dark:bg-slate-600 shadow-sm hover:bg-slate-200 dark:hover:bg-slate-500 transition">+</button>
                                </div>
                                <button data-id="${item.id}" class="remove-item-btn text-red-500 hover:text-red-700 transition"><i class="ph ph-x-circle text-xl"></i></button>
                            </div>`;
                    }).join('');
                
                dom.cartItemsDesktop.innerHTML = cartItemsHTML;
                dom.cartItemsMobile.innerHTML = cartItemsHTML;

                const iva = subtotal * 0.19;
                const total = subtotal + iva;

                dom.cartTotalsDesktop.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between font-medium text-slate-600 dark:text-slate-300 text-sm"><span>${t.subtotal}</span><span>${formatCurrency(subtotal)}</span></div>
                        <div class="flex justify-between font-medium text-slate-600 dark:text-slate-300 text-sm"><span>${t.iva}</span><span>${formatCurrency(iva)}</span></div>
                        <div class="flex justify-between font-bold text-lg text-slate-900 dark:text-white mt-2 border-t border-slate-200 dark:border-slate-700 pt-2"><span>${t.total}</span><span>${formatCurrency(total)}</span></div>
                    </div>`;
                dom.cartTotalsMobile.innerHTML = dom.cartTotalsDesktop.innerHTML;

                const hasItems = cartItemsForActiveShop.length > 0;
                const viewCartButtonColor = currentShop.theme.primaryColor;
                dom.viewCartBtn.className = `btn-base bg-${viewCartButtonColor}-600 hover:bg-${viewCartButtonColor}-700 disabled:bg-${viewCartButtonColor}-300 dark:disabled:bg-${viewCartButtonColor}-800 flex items-center gap-2 disabled:cursor-not-allowed`;

                const buttonsHTML = `
                    <button id="generate-recipe-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 disabled:bg-purple-300 dark:disabled:bg-purple-800 disabled:cursor-not-allowed" ${!hasItems ? 'disabled' : ''}>${t.generateRecipe}</button>
                    <button id="whatsapp-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-2 disabled:bg-green-300 dark:disabled:bg-green-800 disabled:cursor-not-allowed" ${!hasItems ? 'disabled' : ''}><i class="ph-fill ph-whatsapp-logo"></i><span>${t.sendWhatsApp}</span></button>
                    <button id="clear-cart-btn" class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center justify-center gap-2 disabled:bg-red-300 dark:disabled:bg-red-800 disabled:cursor-not-allowed" ${!hasItems ? 'disabled' : ''}><i class="ph ph-trash"></i><span>${t.clearQuote}</span></button>`;
                
                dom.cartButtonsDesktop.innerHTML = buttonsHTML;
                dom.cartButtonsMobile.innerHTML = buttonsHTML;
                
                dom.mobileTotalAmount.textContent = formatCurrency(total);
                dom.viewCartBtn.disabled = !hasItems;
            };

            const updateDarkModeToggle = () => {
                const sunIcon = dom.darkModeToggle.querySelector('.ph-sun');
                const moonIcon = dom.darkModeToggle.querySelector('.ph-moon');
                if (state.darkMode) {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            };
            
            // --- INTERACTION LOGIC ---
            const handleCartAction = (action, productId) => {
                const itemIndex = state.cart.findIndex(item => item.id === productId);
                const existingItem = state.cart[itemIndex];

                switch (action) {
                    case 'add':
                        if (existingItem) existingItem.quantity++;
                        else state.cart.push({ id: productId, quantity: 1 });
                        break;
                    case 'increase': if (existingItem) existingItem.quantity++; break;
                    case 'decrease':
                        if (existingItem && existingItem.quantity > 1) existingItem.quantity--;
                        else if (existingItem) state.cart.splice(itemIndex, 1);
                        break;
                    case 'remove': if (itemIndex > -1) state.cart.splice(itemIndex, 1); break;
                    case 'clear': 
                        const currentShopProducts = SHOPS_CONFIG[state.activeShop].products.map(p => p.id);
                        state.cart = state.cart.filter(item => !currentShopProducts.includes(item.id));
                        break;
                }
                saveState();
                renderCart();
                renderProducts();
            };

            const handleFlyToCartAnimation = (button) => {
                const productCard = button.closest('.product-card-base');
                if (!productCard) return;
                const productIconElement = productCard.querySelector('.text-3xl');
                const productIcon = productIconElement ? productIconElement.cloneNode(true) : document.createElement('span');
                if (!productIconElement) {
                    productIcon.textContent = 'üõí';
                    productIcon.classList.add('text-3xl');
                }
                productIcon.classList.add('fly-to-cart');
                document.body.appendChild(productIcon);
                const startRect = button.getBoundingClientRect();
                const isDesktop = window.innerWidth >= 1024;
                const endTarget = isDesktop ? document.querySelector('#quote-title-desktop i') : dom.mobileCartIcon;
                if (!endTarget) { productIcon.remove(); return; }
                const endRect = endTarget.getBoundingClientRect();
                productIcon.style.left = `${startRect.left + startRect.width / 2}px`;
                productIcon.style.top = `${startRect.top + startRect.height / 2}px`;
                requestAnimationFrame(() => {
                    productIcon.style.left = `${endRect.left + endRect.width / 2}px`;
                    productIcon.style.top = `${endRect.top + endRect.height / 2}px`;
                    productIcon.style.transform = 'scale(0.3)';
                    productIcon.style.opacity = '0';
                });
                setTimeout(() => {
                    productIcon.remove();
                    const cartIcon = isDesktop ? document.querySelector('#quote-title-desktop i') : dom.mobileCartIcon;
                    if (cartIcon) {
                        cartIcon.parentElement.classList.add('cart-pulse');
                        setTimeout(() => cartIcon.parentElement.classList.remove('cart-pulse'), 500);
                    }
                }, 600);
            };

            const toggleModal = (modal, content, show) => {
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        content.classList.remove('scale-95', 'opacity-0');
                        content.classList.add('scale-100', 'opacity-100');
                    }, 10);
                } else {
                    content.classList.remove('scale-100', 'opacity-100');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat(state.lang === 'es' ? 'es-CO' : 'en-US', {
                    style: 'currency', currency: state.currency,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: state.currency === 'COP' ? 0 : 2
                }).format(amount);
            };

            const generateWhatsAppMessage = () => {
                const currentShop = SHOPS_CONFIG[state.activeShop];
                const t = currentShop.translations[state.lang];
                let messageTitle = t.whatsappMessageTitle || `${t.mainTitle} - ${t.quoteTitleDesktop.replace(/<[^>]*>/g, '').trim()}`;
                let message = `${messageTitle}\n\n`;
                let subtotal = 0;
                const activeShopProducts = currentShop.products;
                const cartItemsForActiveShop = state.cart.filter(cartItem => activeShopProducts.some(p => p.id === cartItem.id));
                cartItemsForActiveShop.forEach(item => {
                    const product = activeShopProducts.find(p => p.id === item.id);
                    const itemPrice = product.price * exchangeRates[state.currency];
                    subtotal += itemPrice * item.quantity;
                    message += `${item.quantity} x ${product.name} - ${formatCurrency(itemPrice)} c/u\n`;
                });
                const iva = subtotal * 0.19;
                const total = subtotal + iva;
                message += `\n${t.subtotal} ${formatCurrency(subtotal)}\n`;
                message += `${t.iva} ${formatCurrency(iva)}\n`;
                message += `${t.total} ${formatCurrency(total)}\n\n¬°Gracias por tu compra!`;
                return encodeURIComponent(message);
            };

            // --- GEMINI API FUNCTION ---
            const handleGenerateRecipe = async () => {
                const currentShop = SHOPS_CONFIG[state.activeShop];
                const t = currentShop.translations[state.lang];

                toggleModal(dom.recipeModal, dom.recipeModalContent, true);
                dom.recipeModalTitle.textContent = t.generatingRecipe;
                dom.recipeModalBody.innerHTML = `<div class="flex justify-center items-center p-8"><div class="spinner"></div></div>`;
                
                const activeShopProducts = currentShop.products;
                const ingredients = state.cart
                    .filter(cartItem => activeShopProducts.some(p => p.id === cartItem.id))
                    .map(item => activeShopProducts.find(p => p.id === item.id).name)
                    .join(', ');

                const prompt = state.activeShop === 'butcherShop'
                    ? `Eres un chef experto en carnes. Crea una sugerencia de preparaci√≥n o receta para los siguientes productos: ${ingredients}. Describe el plato, los ingredientes adicionales que se necesitar√≠an y los pasos para prepararlo. Responde en espa√±ol.`
                    : `Eres un chef experto. Crea una receta deliciosa y f√°cil de seguir usando los siguientes ingredientes: ${ingredients}. Proporciona el nombre de la receta, los ingredientes (incluyendo cantidades si es posible), y las instrucciones paso a paso. Formatea la respuesta con t√≠tulos para 'Ingredientes' e 'Instrucciones'. Responde en espa√±ol.`;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key will be injected by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    dom.recipeModalTitle.textContent = t.recipeModalTitle;
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        // Basic formatting for the recipe text
                        const formattedText = text
                            .replace(/(\*\*|__)(.*?)\1/g, '<strong>$2</strong>') // Bold
                            .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italics
                            .replace(/^### (.*$)/gim, '<h3>$1</h3>') // H3
                            .replace(/^## (.*$)/gim, '<h2>$1</h2>') // H2
                            .replace(/^# (.*$)/gim, '<h1>$1</h1>') // H1
                            .replace(/^\* (.*$)/gim, '<li>$1</li>') // List items
                            .replace(/\n/g, '<br>');
                        dom.recipeModalBody.innerHTML = `<div class="prose prose-slate dark:prose-invert max-w-none">${formattedText}</div>`;
                    } else {
                        throw new Error("No content received from API.");
                    }
                } catch (error) {
                    console.error("Error generating recipe:", error);
                    dom.recipeModalTitle.textContent = "Error";
                    dom.recipeModalBody.innerHTML = `<p class="text-red-500">${t.recipeError}</p>`;
                }
            };

            function defineDomElements() {
                const ids = [
                    'main-banner', 'banner-fade-overlay', 'banner-title', 'main-title', 'main-subtitle', 
                    'search-input', 'shop-switcher', 'language-switcher', 'currency-switcher', 
                    'dark-mode-toggle', 'category-filters', 'scroll-left-btn', 'scroll-right-btn', 
                    'products-title', 'product-list', 'quote-title-desktop', 'cart-items-desktop', 
                    'cart-totals-desktop', 'cart-buttons-desktop', 'mobile-cart-bar', 
                    'mobile-total-label', 'mobile-total-amount', 'view-cart-btn', 'mobile-cart-icon', 
                    'view-cart-label', 'mobile-cart-modal', 'modal-content', 'quote-title-mobile', 
                    'close-modal-btn', 'cart-items-mobile', 'cart-totals-mobile', 'cart-buttons-mobile',
                    'recipe-modal', 'recipe-modal-content', 'recipe-modal-title', 'recipe-modal-body',
                    'close-recipe-modal-btn'
                ];
                ids.forEach(id => dom[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id));
            }

            function populateLanguageSwitcher() {
                dom.languageSwitcher.innerHTML = `<option value="es">Espa√±ol</option><option value="en">English</option>`;
            }

            function populateCurrencySwitcher() {
                dom.currencySwitcher.innerHTML = `<option value="COP">COP</option><option value="USD">USD</option><option value="EUR">EUR</option>`;
            }

            const startBannerRotation = () => {
                if (bannerInterval) clearInterval(bannerInterval);
                const currentShop = SHOPS_CONFIG[state.activeShop];
                const bannerImages = currentShop.bannerImages;
                if (!bannerImages || bannerImages.length <= 1) {
                    dom.mainBanner.style.backgroundImage = `url('${currentShop.banner}')`;
                    dom.bannerFadeOverlay.classList.add('opacity-0');
                    return;
                }
                dom.mainBanner.style.backgroundImage = `url('${bannerImages[state.currentBannerIndex]}')`;
                dom.bannerFadeOverlay.classList.add('opacity-0');
                bannerInterval = setInterval(() => {
                    dom.bannerFadeOverlay.classList.remove('opacity-0');
                    dom.bannerFadeOverlay.classList.add('opacity-40');
                    setTimeout(() => {
                        state.currentBannerIndex = (state.currentBannerIndex + 1) % bannerImages.length;
                        dom.mainBanner.style.backgroundImage = `url('${bannerImages[state.currentBannerIndex]}')`;
                        dom.bannerFadeOverlay.classList.remove('opacity-40');
                        dom.bannerFadeOverlay.classList.add('opacity-0');
                    }, 1000);
                }, 5000);
            };

            function setupEventListeners() {
                document.body.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const id = parseInt(button.dataset.id);

                    if (button.classList.contains('add-to-cart-btn')) handleCartAction('add', id);
                    else if (button.classList.contains('increase-quantity-btn')) handleCartAction('increase', id);
                    else if (button.classList.contains('decrease-quantity-btn')) handleCartAction('decrease', id);
                    else if (button.classList.contains('remove-item-btn')) handleCartAction('remove', id);
                    else if (button.id === 'clear-cart-btn') handleCartAction('clear');
                    else if (button.id === 'whatsapp-btn') {
                        const message = generateWhatsAppMessage();
                        const phoneNumber = '573006101221';
                        window.open(`https://api.whatsapp.com/send?phone=${phoneNumber}&text=${message}`, '_blank');
                    }
                    else if (button.id === 'dark-mode-toggle') {
                        state.darkMode = !state.darkMode;
                        document.documentElement.classList.toggle('dark', state.darkMode);
                        saveState();
                        updateDarkModeToggle();
                    } else if (button.dataset.category) {
                        state.activeCategory = button.dataset.category;
                        saveState();
                        renderProducts();
                        renderCategoryFilters();
                    } else if (button.dataset.shop) {
                        state.activeShop = button.dataset.shop;
                        state.activeCategory = 'all';
                        state.searchQuery = '';
                        dom.searchInput.value = '';
                        saveState();
                        updateUI();
                    } else if (button.id === 'view-cart-btn') {
                        toggleModal(dom.mobileCartModal, dom.modalContent, true);
                    } else if (button.id === 'close-modal-btn') {
                        toggleModal(dom.mobileCartModal, dom.modalContent, false);
                    } else if (button.id === 'scroll-left-btn') {
                        dom.categoryFilters.scrollBy({ left: -200, behavior: 'smooth' });
                    } else if (button.id === 'scroll-right-btn') {
                        dom.categoryFilters.scrollBy({ left: 200, behavior: 'smooth' });
                    } else if (button.id === 'generate-recipe-btn') {
                        handleGenerateRecipe();
                    } else if (button.id === 'close-recipe-modal-btn') {
                        toggleModal(dom.recipeModal, dom.recipeModalContent, false);
                    }
                });

                dom.languageSwitcher.addEventListener('change', (e) => { state.lang = e.target.value; saveState(); updateUI(); });
                dom.currencySwitcher.addEventListener('change', (e) => { state.currency = e.target.value; saveState(); updateUI(); });
                dom.searchInput.addEventListener('input', (e) => { state.searchQuery = e.target.value; renderProducts(); });
            }

            init();
        });
    </script>
</body>
</html>
